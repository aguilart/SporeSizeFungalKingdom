---
title: "SummarySporeTraitAnalysis"
author: "Carlos"
date: "22/04/2020"
output:
  html_document: default
  word_document: default
---

Loading data

```{r, message=FALSE, warning=FALSE}
#library(smatr)
library(performance)
library(tidyverse)
library(lme4)
library(lmerTest)
library(MuMIn)
library(broom)
library(pixiedust)
library(phylolm)
source("MatchingSpore_FunctionData.R")

Spore_data2 <- Spore_functions
Spore_data2 <- Spore_data2[-which(duplicated(Spore_data2$names_to_use)),
                           c("phylum","class", "order","family","genus","names_to_use")]

Spore_data2$phylum_ <- Spore_data2$phylum

# Standardizing the taxonomy based on the Mycota

Spore_data2$phylum_[which(Spore_data2$order=="Basidiobolales")] <- "Basidiobolomycota" 
Spore_data2$class[which(Spore_data2$order=="Basidiobolales")] <- "Basidiobolomycetes" 

Spore_data2$phylum_[grep("Blastocladiales|Catenomycetales|Callimastigales", Spore_data2$order)]# Tested, they are clasified as Blastocladiomycota

Spore_data2$phylum_[grep("Calcarisporiellales", Spore_data2$order)] <- "Calcarisporiellomycota" 

Spore_data2$phylum_[grep("Chytridiales|Nephridiophagales|Polyphagales|Saccopodiales|Cladochytriales|Lobulomycetales|Gromochytriales|Mesochytriales|Polychytriales|Rhizophydiales|Rhizophlyctidales|Spizellomycetales|Synchytriales", Spore_data2$order)] #Tested, they are classifed as Chytrids


Spore_data2$phylum_[grep("Entomophthorales|Neozygitales", Spore_data2$order)] <- "Entomophthoromycota" 

Spore_data2$phylum_[grep("Asellariales|Asellarialles|Barbatosporales|Dimargaritales|Harpellales|Kickxellales|Ramicandelaberales", Spore_data2$order)] <- "Kickxellomycota" 

Spore_data2$phylum_[grep("Hyaloraphidiales|Monoblepharidales|Sanchytriales", Spore_data2$order)] <- "Monoblepharomycota" 

Spore_data2$phylum_[grep("Mortierellales", Spore_data2$order)] <- "Mortierellomycota" 

Spore_data2$phylum_[grep("Endogonales|Mucorales|Umbelopsidales", Spore_data2$order)] <- "Mucoromycota" 

Spore_data2$phylum_[grep("Neocallimastigales", Spore_data2$order)] # Tested, listed as Neocallimastigomycota

Spore_data2$phylum_[grep("Metchnikovellida|Amblyosporida|Neopereziida|Ovavesiculida|Glugeida|Nosematida|Chytridiopsida", Spore_data2$order)] <- "Rozellomycota"

Spore_data2$phylum_[Spore_data2$phylum=="Microsporidia"] <- "Rozellomycota"

Spore_data2$phylum_[grep("Zoopagales", Spore_data2$order)] <- "Zoopagomycota" # Tested, listed as

#Spore_data2<-Spore_data2[complete.cases(Spore_data2),]

nta<-
  which(rowSums(sapply(Spore_data2[,c("phylum_","class", "order","family")],
                       function(x){x=="Not assigned"}))!=0)

Spore_data2 <- Spore_data2[-nta, ]

nta<-
  which(rowSums(sapply(Spore_data2[,c("phylum_","class", "order","family")],function(x){x=="Incertae sedis"}))!=0)

Spore_data2 <- Spore_data2[-nta, ]

Spore_data2 <- Spore_data2[complete.cases(Spore_data2), ]


#Using the species from which we have spore data (many more than above)
frm <- ~phylum_/class/order/family/genus/names_to_use

# tax_tree2 <- as.phylo(frm, data = Spore_data2 %>%
#                  mutate_at(c("phylum_","class", "order",
#                              "family","genus","names_to_use"),as.factor))
# 
# 
# tax_tree2<-multi2di(tax_tree2)
# is.binary(tax_tree2)
# 
# #Here what I am doing is giving the same length to all edges
# tax_tree2$edge.length<-rep(1, nrow(tax_tree2$edge))
# 
# saveRDS(tax_tree2, "tax_tree2.RDS")

tax_tree2 <- readRDS("tax_tree2.RDS")

```


```{r}
#pdf("checking_li_unrooted.pdf", width = 18, height = 70)
#plot.phylo(tt, cex = 0.1)
plot.phylo(Li_tree, cex = 0.2)
dev.off()

Li_tree_org <- Li_tree
Li_tree <- tt
```


Supplementary information: Comparing the values obtained from the Algorithm (all with an ID from Mycobank) and data provided by experts

```{r}
#Basidiospores
Expert_data<-
AllFungi[which(grepl("Bassler|Jenna",AllFungi$description__id)&
                 AllFungi$SporeName=="Basidiospores"),]%>%
            group_by(phylum,class,order,family,genus,names_to_use) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(names_to_use,SporeVolume)%>%
  rename(SporeVol_Expert=SporeVolume)

Comp_Expert<-
left_join(Expert_data,
AllFungi[which(AllFungi$names_to_use%in%Expert_data$names_to_use&
                 AllFungi$SporeName=="Basidiospores"&
                 AllFungi$width_extreme==F&
                 AllFungi$length_extreme==F&
                 grepl("[[:digit:]]",AllFungi$description__id)&
                 !grepl("Bassler|Jenna",AllFungi$description__id)),]%>%
            group_by(phylum,class,order,family,genus,names_to_use) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(names_to_use,SporeVolume)%>%
  rename(SporeVol_Algo_extr=SporeVolume))

Comp_Expert<-Comp_Expert[-which(is.na(Comp_Expert$SporeVol_Algo_extr)),]

basidio_comp<-summary(lm(Comp_Expert$SporeVol_Algo_extr~Comp_Expert$SporeVol_Expert))

bas<-
Comp_Expert%>%
  filter(Comp_Expert$SporeVol_Expert<700)%>%
  ggplot()+
  aes(x=SporeVol_Expert,y=SporeVol_Algo_extr)+
  geom_point()+
  geom_smooth(method='lm')+
  labs(title = "Comparision values for Basidiospores",
       subtitle = "y=-12.92+1.29x, r2=0.88, p<0.001, n=317 species",
       x="Spore Volume (um3) experts based",
       y="Spore Volume (um3) algorithm based")

#Ascospores
Expert_data_asc<-#Selecting entries provided by experte
AllFungi[which(grepl("Comp",AllFungi$description__id)&
                 AllFungi$SporeName=="Ascospores"),]%>%
            group_by(phylum,class,order,family,genus,base_name) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(base_name,SporeVolume)%>%
  rename(SporeVol_Expert=SporeVolume)

Comp_Expert_asc<-#Selecting entries extracted with the Algorithm
left_join(Expert_data_asc,
AllFungi[which(AllFungi$base_name%in%Expert_data_asc$base_name&
                 AllFungi$SporeName=="Ascospores"&
                 AllFungi$width_extreme==F&
                 AllFungi$length_extreme==F&
                 grepl("[[:digit:]]",AllFungi$description__id)&
                 !grepl("Comp",AllFungi$description__id)),]%>%
            group_by(phylum,class,order,family,genus,base_name) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(base_name,SporeVolume)%>%
  rename(SporeVol_Algo_extr=SporeVolume))

Comp_Expert_asc<-Comp_Expert_asc[-which(is.na(Comp_Expert_asc$SporeVol_Algo_extr)),]

asco_comp<-summary(lm(Comp_Expert_asc$SporeVol_Algo_extr~Comp_Expert_asc$SporeVol_Expert))

asc<-
Comp_Expert_asc%>%
  #filter(Comp_Expert_con$SporeVol_Expert<700)%>%
  ggplot()+
  aes(x=SporeVol_Expert,y=SporeVol_Algo_extr)+
  geom_point()+
  geom_smooth(method='lm')+
  labs(title = "Comparision values for Ascospores",
       subtitle = "y=14.71+0.98x, r2=0.96, p<0.001, n=41 species",
       x="Spore Volume (um3) experts based",
       y="Spore Volume (um3) algorithm based")



#Conidia
Expert_data_con<-
AllFungi[which(grepl("Comp",AllFungi$description__id)&
                 AllFungi$SporeName=="Conidia"),]%>%
            group_by(phylum,class,order,family,genus,base_name) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(base_name,SporeVolume)%>%
  rename(SporeVol_Expert=SporeVolume)

Comp_Expert_con<-
left_join(Expert_data_con,
AllFungi[which(AllFungi$base_name%in%Expert_data_con$base_name&
                 AllFungi$SporeName=="Conidia"&
                 AllFungi$width_extreme==F&
                 AllFungi$length_extreme==F&
                 grepl("[[:digit:]]",AllFungi$description__id)&
                 !grepl("Comp",AllFungi$description__id)),]%>%
            group_by(phylum,class,order,family,genus,base_name) %>% 
  summarize_at(c("SporeVolume"),mean)%>%
  ungroup()%>%
  select(base_name,SporeVolume)%>%
  rename(SporeVol_Algo_extr=SporeVolume))

Comp_Expert_con<-Comp_Expert_con[-which(is.na(Comp_Expert_con$SporeVol_Algo_extr)),]

coni_comp<-summary(lm(Comp_Expert_con$SporeVol_Algo_extr~Comp_Expert_con$SporeVol_Expert))

con<-
Comp_Expert_con%>%
  #filter(Comp_Expert_con$SporeVol_Expert<700)%>%
  ggplot()+
  aes(x=SporeVol_Expert,y=SporeVol_Algo_extr)+
  geom_point()+
  geom_smooth(method='lm')+
  labs(title = "Comparision values for Conidia",
       subtitle = "y=111.68+0.98x, r2=0.96, p<0.001, n=229 species",
       x="Spore Volume (um3) experts based",
       y="Spore Volume (um3) algorithm based")


```


Exporting the figure of the comparison
```{r}
png("Figures/Fig_S4_Comparison_values.png",width = 180,height = 360,units="mm",res = 300)
gridExtra::grid.arrange(bas,asc,con,nrow=3)
dev.off()

```



# About the datasets

There are 4 datasets with fungal data:

1. AllFungi: contains all info on the names and taxonomy used (the source of taxonomy, which is mostly CoL), the descriptions id, the spore types and the spore names (conidia, chlamydospores, basidiospores, etc). This dataset is basically the result of the assembly of text mining all the descriptions in Mycobank.

2. Spore_data: It contains simplified information on spore dimensions for all fungi. That is, I summarized entries repeated because different descriptions ID and/or species having different names. I also summarized the sporeName to only considers 4 spore type categories as we discuss in the manuscript (meiosproes, mitospores, multinucleate sexual and multinucleate asexual spores).

3. "Spore_functions"  contains all the info as in Spore_data plus functional data (if any). For species without functional data, the entries have NAs

4. To_Analysis: It contians information for the subset of species for which we have both spore data (spore data from Spore_data) and functional data


# Statistical analysis



Counting how much information we have
```{r}
#unique species names collected through data assembly
length(unique(AllFungi$base_name))

#unique species names obtained only through text mining from Mycobank
length(unique(AllFungi$base_name[which(AllFungi$source_base_name=="Mycobank")]))

#unique species names complemented by other sources
length(
  unique(AllFungi$base_name[which(AllFungi$source_base_name!="Mycobank")])[-which(
    unique(AllFungi$base_name[which(AllFungi$source_base_name!="Mycobank")])%in%unique(AllFungi$base_name[which(AllFungi$source_base_name=="Mycobank")])
  )]
  
  
)

#unique accepted names after correcting for taxonomy in the Catalogue of Life (accessed on December 2019)
length(unique(AllFungi$names_to_use))


#unique accepted names for which we have functional trait data
length(unique(To_Analysis$names_to_use))

length(unique(To_Analysis$names_to_use))/length(unique(AllFungi$names_to_use))

```



# Differences among spore types

AM spores vs other asexual spores
```{r}
library(lme4)
library(performance)

#Li dataset

dat2 <- Li_tree_names[which(Li_tree_names$SporeType=="Mitospores"|
                         Li_tree_names$SporeType=="Multinucleate asexual spores"), ]

dat2 <- dat2[-which(dat2$orginal_tree_names == "Mucor_indicus"|
                         dat2$orginal_tree_names == "Mucor_racemosus"|
                           dat2$orginal_tree_names == "Rhizopus_azygosporus"), ]

rownames(dat2) <- dat2$orginal_tree_names

AM_vs_Mito_Li<-
  phylolm(log10(SporeVolume) ~ SporeType,
          data = dat2,
          phy = Li_tree, model = "lambda")

rm(dat2)

#Cladogram dataset

dat1<-Spore_data[which(Spore_data$SporeType=="Mitospores"|
                         Spore_data$SporeType=="Multinucleate asexual spores"),]

dat1<-dat1[-grep("Zygomy",dat1$phylum),]
rownames(dat1)<-dat1$names_to_use

AM_vs_Mito<-
phylolm(log10(SporeVolume)~SporeType,
        phy = tax_tree2,
        model = "lambda",
        data = dat1)

Simple_AM_vs_Mito<-
lm(log10(SporeVolume)~SporeType,
        #phy = tree_Spore_data,
        #model = "lambda",
        data = dat1)

```

Comparisons made with Li subset
```{r}
summary(AM_vs_Mito_Li)
```

Comparison made with cladograms
```{r}
summary(AM_vs_Mito)
```

No correction at all
```{r}
summary(Simple_AM_vs_Mito)
```

In this case AM Spores are 3.5 order of magnitude larger than mitospores. A result that is consistent in all models


AM spores vs sexual spores

```{r}
#AM_vs_Meiospores
dat2<-Li_tree_names[which(Li_tree_names$SporeType=="Meiospores"|
                         Li_tree_names$SporeType=="Multinucleate asexual spores"),]

rownames(dat2)<-dat2$orginal_tree_names

AM_vs_Meio_Li<-
  phylolm(log10(SporeVolume) ~ SporeType,
          data = dat2,
         
          phy = Li_tree, model = "lambda")

rm(dat2)

#cladogram
dat1<-Spore_data[which(Spore_data$SporeType=="Meiospores"|
                         Spore_data$SporeType=="Multinucleate asexual spores"),]

dat1<-dat1[-grep("Zygomy",dat1$phylum),]
rownames(dat1)<-dat1$names_to_use

# pruned.tree_1<-drop.tip(tree_Spore_data,
#                 tree_Spore_data$tip.label[!tree_Spore_data$tip.label%in%dat1$names_to_use])

AM_vs_Meio<-
phylolm(log10(SporeVolume)~SporeType,
        phy = tax_tree2,
        model = "lambda",
        data = dat1)


Simple_AM_vs_Meio<-
lm(log10(SporeVolume)~SporeType,
        #phy = tree_Spore_data,
        #model = "lambda",
        data = dat1)
#summary(Simple_AM_vs_Meio)
```

Comparison using the Li subset
```{r}
summary(AM_vs_Meio_Li)
```

Comparison using the cladogram
```{r}
summary(AM_vs_Meio)
```

Not incorporating phylogeny
```{r}
summary(Simple_AM_vs_Meio)
```


Comparisons with Zygos

```{r}
##AM_vs_Multinucleate sexual (zygo ones)

dat2<-Li_tree_names[grep("Zygomy|Glomero",Li_tree_names$phylum),]

dat2<-dat2[-which(grepl("Zygomy",dat2$phylum)&
                         dat2$SporeType=="Mitospores"),]

dat2$SporeType[which(dat2$SporeType=="Multinucleate sexual spores")]<-"A_Zygo spores"
dat2$SporeType[which(dat2$SporeType=="Multinucleate asexual spores")]<-"B_AM spores"

rownames(dat2)<-dat2$orginal_tree_names

#####

dat1<-Spore_data[grep("Zygomy|Glomero",Spore_data$phylum),]
dat1<-dat1[-which(dat1$SporeType=="Mitospores"),]

dat1$SporeType[grep("Zygomy",dat1$phylum)]<-"A_Zygo spores"
dat1$SporeType[grep("Glomero",dat1$phylum)]<-"B_AM spores"

dat1<-dat1[-which(duplicated(dat1$names_to_use)),]

rownames(dat1)<-dat1$names_to_use


# pruned.tree_1<-drop.tip(tree_Spore_data,
#                 tree_Spore_data$tip.label[!tree_Spore_data$tip.label%in%dat1$names_to_use])

AM_vs_ZygoS_Li<-
phylolm(log10(SporeVolume)~SporeType,
        phy = Li_tree,
        model = "lambda",
        data = dat2)

AM_vs_ZygoS<-
phylolm(log10(SporeVolume)~SporeType,
        phy = tax_tree2,
        model = "lambda",
        data = dat1)

Simple_AM_vs_ZygoS<-
lm(log10(SporeVolume)~SporeType,
        #phy = tree_Spore_data,
        #model = "lambda",
        data = dat1)

```


```{r}
summary(AM_vs_ZygoS_Li)
```

with the cladograms
```{r}
summary(AM_vs_ZygoS)
```

without phylogenetic corrections
```{r}
summary(Simple_AM_vs_ZygoS)
```



Basidiospores vs Ascospores

```{r}
meiospores<-Li_tree_names[which(Li_tree_names$SporeType=="Meiospores"),]

meiospores$Type<-NA
meiospores$Type[grep("Asco",meiospores$phylum)]<-"ascospores"
meiospores$Type[grep("Basidio",meiospores$phylum)]<-"basidiospores"

rownames(meiospores)<-meiospores$orginal_tree_names

asco_vs_basidio_Li<-
phylolm(log10(SporeVolume)~Type,
        phy = Li_tree,
        model = "lambda",
        data = meiospores);rm(meiospores)



dat1<-Spore_data[which(Spore_data$SporeType=="Meiospores"),]

dat1$Type<-NA
dat1$Type[grep("Asco",dat1$phylum)]<-"ascospores"
dat1$Type[grep("Basidio",dat1$phylum)]<-"basidiospores"

rownames(dat1)<-dat1$names_to_use

asco_vs_basidio<-
phylolm(log10(SporeVolume)~Type,
        phy = tax_tree2,
        model = "lambda",
        data = dat1)


asco_vs_basidio_simple<-
lm(log10(SporeVolume)~Type,
        #phy = tree_Spore_data,
        #model = "lambda",
        data = dat1);rm(dat1)
```

Comparison made with the Li subset
```{r}
summary(asco_vs_basidio_Li)
```

Comparison made with the cladograms
```{r}
summary(asco_vs_basidio)
```

Comparisons without incorporating phylogeny
```{r}
summary(asco_vs_basidio_simple)
```


## Question 1: Does spore size co-varies with functional groups?

For asking this question I have to separate it into distinct spore types; only sexual (meiospore) and asexual (mitospores). 


Making the models
```{r, echo=FALSE}
mi<-which(Li_tree_names$SporeType=="Meiospores")
mo<-which(Li_tree_names$SporeType=="Mitospores")
mn<-which(Li_tree_names$SporeType=="Multinucleate sexual spores")
ma<-which(Li_tree_names$SporeType=="Multinucleate asexual spores")

#Meiospores

meiospores<-Li_tree_names[mi,]

#Removing the groups for which we have less than 3 species per function and "unknown" functions
few <- names(which(table(meiospores$simpleFunct)<3))

meiospores <- meiospores[-which(meiospores$simpleFunct %in% few), ]
meiospores <- meiospores[-which(meiospores$simpleFunct == "Unknown"), ]

meiospores <- meiospores[-which(meiospores$phylum == "Blastocladiomycota"|
                                  meiospores$phylum == "Microsporidia"), ]# There are only 1 representative for each of these phyla

rownames(meiospores)<-meiospores$orginal_tree_names

styles <- c("AFree living", "B_Opportunistic association",
            "Facultative association", "Obligate association") 

meiospores <- meiospores[which(meiospores$Life_style %in% styles), ]
rownames(meiospores)<-meiospores$orginal_tree_names


#Mitospores
mitospores<-Li_tree_names[mo,]

#Removing the groups for which we have less than 3 species per function and "unknown" functions
few <- names(which(table(mitospores$simpleFunct)<3))

mitospores <- mitospores[-which(mitospores$simpleFunct %in% few), ]
mitospores <- mitospores[-which(mitospores$simpleFunct == "Unknown"), ]

rownames(mitospores)<-mitospores$orginal_tree_names

mitospores <- mitospores[which(mitospores$Life_style %in% styles), ]
rownames(mitospores)<-mitospores$orginal_tree_names

#Meiospores
meiospores2<-To_Analysis[grep("eiospores",To_Analysis$SporeType),]

few <- names(which(table(meiospores2$simpleFunct)<3))

meiospores2 <- meiospores2[-which(meiospores2$simpleFunct %in% few), ]
meiospores2 <- meiospores2[-which(meiospores2$simpleFunct == "Unknown"), ]
#meiospores2<-meiospores2[-which(meiospores2$Life_style=="Fungi"),]
rownames(meiospores2)<-meiospores2$names_to_use

meiospores2 <- meiospores2[which(meiospores2$Life_style %in% styles), ]

meiospores2 <- meiospores2[-which(meiospores2$phylum == "Blastocladiomycota"|
                                  meiospores2$phylum == "Microsporidia"), ]# There are only 1 representative for each of these phyla

rownames(meiospores2) <- meiospores2$names_to_use

#Mitospores
mitospores2<-To_Analysis[grep("itospores", To_Analysis$SporeType), ]

few <- names(which(table(mitospores2$simpleFunct)<3))

mitospores2 <- mitospores2[-which(mitospores2$simpleFunct %in% few), ]
mitospores2 <- mitospores2[-which(mitospores2$simpleFunct == "Unknown"), ]
#mitospores2<-mitospores2[-which(duplicated(mitospores2$names_to_use)),]#For some weird reason one species is duplicated, all values are exactly the same so I just removed it
#mitospores2<-mitospores2[-which(mitospores2$Life_style=="Fungi"),]
#mitospores2<-mitospores2[-which(mitospores2$Life_style=="Animal"),]

rownames(mitospores2)<-mitospores2$names_to_use

mitospores2 <- mitospores2[which(mitospores2$Life_style %in% styles), ]
rownames(mitospores2) <- mitospores2$names_to_use
```


```{r, echo=FALSE}

# meiospores_r <-
# rbind(meiospores, Li_tree_names[which(Li_tree_names$orginal_tree_names == "Thamnocephalis_sphaerospora"),])
# rownames(meiospores_r)<-meiospores$orginal_tree_names

mod_Li_meios<-
  phylolm(log10(SporeVolume) ~ simpleFunct,
          data = meiospores,
         
          phy = Li_tree,
          #phy = Li_tree2,
          model = "lambda")

mod_tax_meios<-
  phylolm(log10(SporeVolume) ~ simpleFunct,
          data = meiospores2,
          phy = tax_tree2,#tree_To_Analysis,#pruned.tree_me,#tax_tree,# #
          model = "lambda")


mod_Li_mitos<-phylolm(log10(SporeVolume) ~ simpleFunct,
              data = mitospores,
              phy = Li_tree, 
              #phy = Li_tree2,
              model = "lambda")


mod_tax_mitos<-phylolm(log10(SporeVolume) ~ simpleFunct,
              data = mitospores2,
              phy = tax_tree2, model = "lambda")

```

Saving the outputs for each model: both types of spore and the phylogenetic and taxonomic tree

For Meiospores

```{r}
summary(mod_Li_meios)
muestra <- mod_Li_meios$n
modelo <- summary(mod_Li_meios)

Li_meios1 <- 
  data.frame(
      model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
      Pagels_lambda = modelo$optpar,
      r2 = modelo$r.squared,
      n = muestra)

Li_meios1 <-
rapply(Li_meios1, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_meios2 <- 
    broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_meios2 <-
rapply(Li_meios2, classes = "numeric", how = "replace", function(x){round(x, 2)})

```


```{r}
summary(mod_tax_meios)
muestra <- mod_tax_meios$n
modelo <- summary(mod_tax_meios)

tax_meios1 <- 
  data.frame(
      model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
      Pagels_lambda = modelo$optpar,
      r2 = modelo$r.squared,
      n = muestra)

tax_meios1 <-
rapply(tax_meios1, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_meios2 <- 
    broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_meios2 <-
rapply(tax_meios2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```

For Mitospores

```{r}
summary(mod_Li_mitos)

muestra <- mod_Li_mitos$n
modelo <- summary(mod_Li_mitos)

Li_mitos1 <- 
  data.frame(
      model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
      Pagels_lambda = modelo$optpar,
      r2 = modelo$r.squared,
      n = muestra)

Li_mitos1 <-
rapply(Li_mitos1, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_mitos2 <- 
    broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_mitos2 <-
rapply(Li_mitos2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```


```{r}
summary(mod_tax_mitos)

muestra <- mod_tax_mitos$n
modelo <- summary(mod_tax_mitos)

tax_mitos1 <- 
  data.frame(
      model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
      Pagels_lambda = modelo$optpar,
      r2 = modelo$r.squared,
      n = muestra)

tax_mitos1 <-
rapply(tax_mitos1, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_mitos2 <- 
    broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_mitos2 <-
rapply(tax_mitos2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```

Supplemantary Information: Saving the output of these models as a table for the manuscript

```{r}
limpia <- function(x){
  names(x)[1] <- "group" 
x$group[grep("tercept" ,x$group)] <- "Asymbiotic saptrotrophs"
x$group[grep("human" ,x$group, ignore.case = T)] <- "Human pathogens"
x$group[grep("insect" ,x$group, ignore.case = T)] <- "Insect pathogens"
x$group[grep("Lichen" ,x$group, ignore.case = T)] <- "Lichen fungi"
x$group[grep("Ecto" ,x$group, ignore.case = T)] <- "Ectomycorrhizal"
x$group[grep("endoph" ,x$group, ignore.case = T)] <- "Plant endophyte"
x$group[grep("mildew" ,x$group, ignore.case = T)] <- "Mildew fungi (plant pathogens)"
x$group[grep("necro" ,x$group, ignore.case = T)] <- "Necrotroph (plant pathogens)"
x$group[grep("rust" ,x$group, ignore.case = T)] <- "Rust fungi(plant pathogens)"
x$group[grep("smut" ,x$group, ignore.case = T)] <- "Smut fungi (plant pathogens)"
x$group[grep("undefined" ,x$group, ignore.case = T)] <- "Undefined plant pathogens"
x
}

Li_meios2 <- limpia(Li_meios2)
tax_meios2 <- limpia(tax_meios2)
Li_mitos2 <- limpia(Li_mitos2)
tax_mitos2 <- limpia(tax_mitos2)

tablas <- 
rbind(as.matrix(Li_meios1),
      matrix(names(Li_meios2), nrow = 1, ncol = 4), as.matrix(Li_meios2),
      matrix(names(tax_meios1), nrow = 1, ncol = 4), as.matrix(tax_meios1),
      matrix(names(tax_meios2), nrow = 1, ncol = 4), as.matrix(tax_meios2),
      
      matrix(names(Li_mitos1), nrow = 1, ncol = 4), as.matrix(Li_mitos1), 
      matrix(names(Li_mitos2), nrow = 1, ncol = 4), as.matrix(Li_mitos2),
      
      matrix(names(tax_mitos1), nrow = 1, ncol = 4), as.matrix(tax_mitos1), 
      matrix(names(tax_mitos2), nrow = 1, ncol = 4), as.matrix(tax_mitos2))

rm(Li_meios1,Li_meios2,tax_meios1,tax_meios2,Li_mitos1,Li_mitos2, tax_mitos1,tax_mitos2)
write.csv(tablas,
          "model_outputs/simple_funct_models.csv",
          row.names = F)

```



## Question 2: Do more symbiotic fungi have larger spores?

I do this with a priori contrasts:

* Life_style1: free living against symbionts
* Life_style2: free living  vs opportunistic symbionts
* Life_style2: Faculative vs Obligate

Making the models

```{r,echo=FALSE}

mi<-which(Li_tree_names$SporeType=="Meiospores")
mo<-which(Li_tree_names$SporeType=="Mitospores")
mn<-which(Li_tree_names$SporeType=="Multinucleate sexual spores")
ma<-which(Li_tree_names$SporeType=="Multinucleate asexual spores")

#Meiospores

meiospores<-Li_tree_names[mi,]

#specifying that only life styles in the hypothesis are including

styles <- c("AFree living", "B_Opportunistic association",
            "Facultative association", "Obligate association") 

meiospores <- meiospores[which(meiospores$Life_style %in% styles), ]
rownames(meiospores)<-meiospores$orginal_tree_names


#Mitospores
mitospores<-Li_tree_names[mo,]

#Removing the groups for which we have less than 3 species per function and "unknown" functions
mitospores <- mitospores[which(mitospores$Life_style %in% styles), ]
rownames(mitospores)<-mitospores$orginal_tree_names

#Meiospores
meiospores2 <- To_Analysis[grep("eiospores",To_Analysis$SporeType),]
meiospores2 <- meiospores2[which(meiospores2$Life_style %in% styles), ]
rownames(meiospores2) <- meiospores2$names_to_use

#Mitospores
mitospores2<-To_Analysis[grep("itospores", To_Analysis$SporeType), ]
mitospores2 <- mitospores2[which(mitospores2$Life_style %in% styles), ]
mitospores2<-mitospores2[-which(duplicated(mitospores2$names_to_use)),]#For some weird reason one species is duplicated, all values are exactly the same so I just removed it
rownames(mitospores2)<-mitospores2$names_to_use


#Contrasts
meiospores$Life_style<-as.factor(meiospores$Life_style)
#levels(meiospores$Life_style)
contrasts(meiospores$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)

mitospores$Life_style<-as.factor(mitospores$Life_style)
#levels(mitospores$Life_style)
contrasts(mitospores$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)

#################################################################

meiospores2$Life_style<-as.factor(meiospores2$Life_style)
levels(meiospores2$Life_style)
contrasts(meiospores2$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)


mitospores2$Life_style<-as.factor(mitospores2$Life_style)
levels(mitospores2$Life_style)
contrasts(mitospores2$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)

mod_Li_meios_symb<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = meiospores,
          phy = Li_tree,
          #phy = Li_tree2,
          model = "lambda")

mod_Li_mitos_symb<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = mitospores,
          phy = Li_tree,
          #phy = Li_tree2,
          model = "lambda")

mod_tax_meios_symb<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = meiospores2,
          
          phy = tax_tree2,
          #phy = Li_tree2,
          model = "lambda")

mod_tax_mitos_symb<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = mitospores2,
          
          phy = tax_tree2,
          #phy = Li_tree2,
          model = "lambda")

```

Saving the outputs of the models

first with the with the Li data
```{r}
summary(mod_Li_meios_symb)

muestra <- mod_Li_meios_symb$n
modelo <- summary(mod_Li_meios_symb)

Li_meios_symb1 <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

Li_meios_symb1 <-
  rapply(Li_meios_symb1, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_meios_symb2 <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_meios_symb2 <-
  rapply(Li_meios_symb2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```


```{r}
summary(mod_tax_meios_symb)

muestra <- mod_tax_meios_symb$n
modelo <- summary(mod_tax_meios_symb)

tax_meios_symb1 <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

tax_meios_symb1 <-
  rapply(tax_meios_symb1, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_meios_symb2 <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_meios_symb2 <-
  rapply(tax_meios_symb2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```



Asexual spores
```{r}
summary(mod_Li_mitos_symb)

muestra <- mod_Li_mitos_symb$n
modelo <- summary(mod_Li_mitos_symb)

Li_mitos_symb1 <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

Li_mitos_symb1 <-
  rapply(Li_mitos_symb1, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_mitos_symb2 <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_mitos_symb2 <-
  rapply(Li_mitos_symb2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```



```{r}
summary(mod_tax_mitos_symb)
muestra <- mod_tax_mitos_symb$n
modelo <- summary(mod_tax_mitos_symb)

tax_mitos_symb1 <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

tax_mitos_symb1 <-
  rapply(tax_mitos_symb1, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_mitos_symb2 <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_mitos_symb2 <-
  rapply(tax_mitos_symb2, classes = "numeric", how = "replace", function(x){round(x, 2)})
```

Supplementary information: saving the output of the models for supplementary information

```{r}
limpia2 <- function(x){
  names(x)[1] <- "contrast" 
  x$contrast[grep("Life_style1", x$contrast)] <- "Free-living vs Symbiotic"
  x$contrast[grep("Life_style2", x$contrast)] <- "Saprotrophic vs Opportunistic symbionts"
  x$contrast[grep("Life_style3" ,x$contrast)] <- "Facultative symbionts vs Obligate Symbionts"
  x
}

Li_meios_symb2 <- limpia2(Li_meios_symb2)
tax_meios_symb2 <- limpia2(tax_meios_symb2)
Li_mitos_symb2 <- limpia2(Li_mitos_symb2)
tax_mitos_symb2 <- limpia2(tax_mitos_symb2)

tablas2 <- 
rbind(as.matrix(Li_meios_symb1),
      matrix(names(Li_meios_symb2), nrow = 1, ncol = 4), as.matrix(Li_meios_symb2),
      
      matrix(names(tax_meios_symb1), nrow = 1, ncol = 4), as.matrix(tax_meios_symb1),
      matrix(names(tax_meios_symb2), nrow = 1, ncol = 4), as.matrix(tax_meios_symb2),
      
      matrix(names(Li_mitos_symb1), nrow = 1, ncol = 4), as.matrix(Li_mitos_symb1), 
      matrix(names(Li_mitos_symb2), nrow = 1, ncol = 4), as.matrix(Li_mitos_symb2),
      
      matrix(names(tax_mitos_symb1), nrow = 1, ncol = 4), as.matrix(tax_mitos_symb1), 
      matrix(names(tax_mitos_symb2), nrow = 1, ncol = 4), as.matrix(tax_mitos_symb2))

tablas2 <- tablas2[-grep("Intercept", tablas2[,1]), ]

rm(Li_meios_symb1,Li_meios_symb2, tax_meios_symb1, tax_meios_symb2,
   Li_mitos_symb1,Li_mitos_symb2, tax_mitos_symb1, tax_mitos_symb2)

write.csv(tablas2,
          "model_outputs/contrast_models.csv",
          row.names = F)

write.table(tablas2,
          "model_outputs/contrast_models.txt", sep =";",
          row.names = F)
```



Another analysis

```{r}
meiospores$Life_style[meiospores$Life_style=="B_Opportunistic association"] <- "AFree living"

mod_Li_meios_symb_no_contrast<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = meiospores,
          phy = Li_tree,
          #phy = Li_tree2,
          model = "lambda")

summary(mod_Li_meios_symb_no_contrast)
```



# 3.Determinig the relative importance of climate vs life style in explaining interpecific spore variation 

First with the Li tree

```{r}
dat$orginal_tree_names<-dat$Species

trial1<-left_join(
  Li_tree_names[,c("orginal_tree_names","SporeType","SporeVolume","simpleFunct","Life_style","phylum","class","order","family","genus")],
  dat %>%
    select(orginal_tree_names, host.assoc, log10.sporeVolume, log10.sporeAspectRatio, ends_with('mean'), n_samples_env))

trial1<-trial1[complete.cases(trial1),]

# this is weird that there are species without assignments
trial1<-trial1 %>% 
  #filter(!order == 'Not assigned') %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative association"), 
         Life_style = recode(Life_style, "B_Opportunistic association" = "AFree living"), #Just added this
         Life_style = ordered(Life_style))#, 
         # Life_style = poly(as.numeric(Life_style, 1)))

trial1<-
trial1 %>%#filter(!grepl("Multi",SporeType)) %>%
                 mutate_at(c("mat_mean", "map_mean", "seasonality_t_mean", 
                             "seasonality_p_mean", "maxsrad_mean","minvapr_mean"),scale)
rownames(trial1)<-trial1$orginal_tree_names

# pruned.tree_trial1<-drop.tip(Li_tree,
#                 Li_tree$tip.label[!Li_tree$tip.label%in%trial1$orginal_tree_names])


m_all <- phylolm(log10(SporeVolume) ~ Life_style + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean+ SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
m_no_life_style <- phylolm(log10(SporeVolume) ~ #Life_style + 
               mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean+ SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
m_no_mat_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
               #mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  
  m_no_map_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 #map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  m_no_seasonality_t_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 #seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
                   SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  m_no_seasonality_p_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 #seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,  
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  m_no_maxsrad_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 #maxsrad_mean + 
                 minvapr_mean+
               SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  m_no_minvapr_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 #minvapr_mean+
               SporeType,
               phy = Li_tree,
               model = "lambda",
               data=trial1)
  
  
  
  modelos<-list(m_all,m_no_life_style,
                m_no_mat_mean,m_no_map_mean,
                m_no_seasonality_t_mean,m_no_seasonality_p_mean,
                m_no_maxsrad_mean,m_no_minvapr_mean)
  names(modelos)<-c("m_all","m_no_life_style",
                "m_no_mat_mean","m_no_map_mean",
                "m_no_seasonality_t_mean","m_no_seasonality_p_mean",
                "m_no_maxsrad_mean","m_no_minvapr_mean")
  
  resultados<-
  do.call("rbind",
  lapply(modelos, function(x){#y<-r2_nakagawa(x)
  data.frame(adj.r.squared=summary(x)$adj.r.squared,
             #R2_fixed=y$R2_marginal,
    df=logLik.phylolm(x)[2],         
    Log_likelihood=logLik.phylolm(x)[1],
    AIC=AIC.phylolm(x),
    dataset = paste(x$call$phy, " (","n=", x$n, ")", sep = "") )} ))
  
  resultados$dAIC<-resultados$AIC-resultados$AIC[1]
  resultados$Model<-rownames(resultados);rownames(resultados)<-NULL
  resultados<-resultados[,c("Model","adj.r.squared", "logLik",
                            "AIC", "dAIC", "dataset")]
  resultados_Li_tree<-resultados
  
  
```



```{r, echo=FALSE,message=FALSE,warning=FALSE}
dat$names_to_use<-gsub("_"," ",dat$Species)

trial<-left_join(dat %>% 
                  select(names_to_use, host.assoc, log10.sporeVolume, log10.sporeAspectRatio, ends_with('mean'), n_samples_env), 
                 To_Analysis[,c("names_to_use","SporeType","SporeVolume","simpleFunct","Life_style")])

trial <-left_join(trial, Spore_data2)

# trial<-trial[complete.cases(trial),]
# nta<-
# which(rowSums(sapply(trial[,c("phylum","class", "order","family")],function(x){x=="Not assigned"}))==1)

#trial<-trial[-nta,]
trial<-trial[complete.cases(trial),]

# this is weird that there are species without assignments
trial<-trial %>% 
  #filter(!order == 'Not assigned') %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative association"), 
         Life_style = recode(Life_style, "B_Opportunistic association" = "AFree living"),
         Life_style = ordered(Life_style))

trial<-
trial %>%#filter(!grepl("Multi",SporeType)) %>%
                 mutate_at(c("mat_mean", "map_mean", "seasonality_t_mean", 
                             "seasonality_p_mean", "maxsrad_mean","minvapr_mean"),scale)

rownames(trial)<-trial$names_to_use

#2. One for the geographic data, that is for dat
frm <- ~phylum_/class/order/family/genus/names_to_use

tree_trial <- as.phylo(frm, data = trial %>%
                 mutate_at(c("phylum_","class", "order",
                             "family","genus","names_to_use"),as.factor))
is.binary.tree(tree_trial)

tree_trial<-multi2di(tree_trial)
is.binary.tree(tree_trial)

tree_trial$edge.length<-rep(1, nrow(tree_trial$edge))

#plot(tree_trial,cex = 0.01)#Now this work

m_all <- phylolm(log10(SporeVolume) ~ Life_style + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean+ SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
m_no_life_style <- phylolm(log10(SporeVolume) ~ #Life_style + 
               mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean+ SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
m_no_mat_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
               #mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
  
  m_no_map_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 #map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
  m_no_seasonality_t_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 #seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
                   SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
  m_no_seasonality_p_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 #seasonality_p_mean + 
                 maxsrad_mean + 
                 minvapr_mean+
               SporeType,  
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
  m_no_maxsrad_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 #maxsrad_mean + 
                 minvapr_mean+
               SporeType,
              phy = tree_trial,
               model = "lambda",
               data=trial)
  
  m_no_minvapr_mean <- phylolm(log10(SporeVolume) ~ Life_style + 
                 mat_mean + 
                 map_mean + 
                 seasonality_t_mean + 
                 seasonality_p_mean + 
                 maxsrad_mean + 
                 #minvapr_mean+
               SporeType,
               phy = tree_trial,
               model = "lambda",
               data=trial)
  
  
  
  modelos<-list(m_all,m_no_life_style,
                m_no_mat_mean,m_no_map_mean,
                m_no_seasonality_t_mean,m_no_seasonality_p_mean,
                m_no_maxsrad_mean,m_no_minvapr_mean)
  names(modelos)<-c("m_all","m_no_life_style",
                "m_no_mat_mean","m_no_map_mean",
                "m_no_seasonality_t_mean","m_no_seasonality_p_mean",
                "m_no_maxsrad_mean","m_no_minvapr_mean")
  
  resultados<-
  do.call("rbind",
  lapply(modelos, function(x){#y<-r2_nakagawa(x)
  data.frame(adj.r.squared=summary(x)$adj.r.squared,
             #R2_fixed=y$R2_marginal,
    df=logLik.phylolm(x)[2],         
    Log_likelihood=logLik.phylolm(x)[1],
    AIC=AIC.phylolm(x),
    dataset = paste(x$call$phy, " (","n=", x$n, ")", sep = "") )} ))
  
  resultados$dAIC<-resultados$AIC-resultados$AIC[1]
  resultados$Model<-rownames(resultados);rownames(resultados)<-NULL
  resultados<-resultados[,c("Model","adj.r.squared", "logLik",
                            "AIC", "dAIC", "dataset")]
  
  resultados_tax_tree<-resultados;rm(resultados)
  
```

Based on the Li subset
```{r}
resultados_Li_tree
```


Based on the cladograms
```{r}
resultados_tax_tree
```


```{r}

resultados_all <-
bind_rows(resultados_Li_tree, resultados_tax_tree)

m <- c(rbind(c(1:8),c(9:16)))

resultados_all <- resultados_all[m, ]

resultados_all <- rapply(resultados_all, classes = "numeric", how = "replace",
                         function(x){round(x, 2)})

resultados_all$Model <- c("All variables"," ", "(-) Symbiotic lifestyle", " ",
                          "(-) mean annual temperature", " ", "(-) mean annual precipitation", " ",
                          "(-) Temperature seasonality", " ", "(-) Precipitation seasonality", " ",
                          "(-) Maximum solar radiation", " ", "(-) Minimum vapor pressure", " ")

resultados_all$dataset <- gsub("Li_tree", "Model 1", resultados_all$dataset)
resultados_all$dataset <- gsub("tree_trial", "Model 2", resultados_all$dataset)

write.table(resultados_all,
          "model_outputs/table_1.txt", sep =";",
          row.names = F)

```




## Spore aspect ratio
```{r}

### spore aspect ratio

## global model
m1 <- lm(log10.sporeAspectRatio ~ order + simpleFunct + SporeType + 
             alt_mean + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean, data=trial)
# # plot to check for nonlinearities
# tmp <- m1$model %>%
#   mutate_if(is.character, as.factor)
# for(i in 2:ncol(tmp)) plot(tmp$log10.sporeAspectRatio ~ tmp[, i], main=names(tmp)[i])

## results for individual variables
m1.var <- vector('list', length=ncol(m1$model))
names(m1.var) <- c('<none>', names(m1$model)[2:ncol(m1$model)])
m1.var[[1]] <- m1$model
for(i in 2:length(m1.var)) m1.var[[i]] <- m1$model[, -i]
m1.aic <- lapply(m1.var, function(x)AIC(m1, lm(log10.sporeAspectRatio ~ ., data=x)))
m1.drp <- data.frame(term = names(m1.var), 
                     Df = sapply(m1.aic, function(x)x[2, 'df']), 
                     AIC = sapply(m1.aic, function(x)x[2, 'AIC']), 
                     AdjR2 = sapply(m1.var, function(x)summary(lm(log10.sporeAspectRatio ~ ., data=x))[['adj.r.squared']])) %>% 
  mutate(type = c('global', rep('subset', n() - 1)), 
         dAIC = AIC - AIC[1], 
         dAdjR2 = AdjR2 - AdjR2[1]) %>% 
  group_by(type) %>% 
  arrange(desc(dAIC), .by_group=TRUE) %>% 
  ungroup() %>% 
  select(term, Df, AIC, dAIC, AdjR2, dAdjR2)

## results for variable groups
# drop taxonomy
m2.tax <- lm(log10.sporeAspectRatio ~ simpleFunct + SporeType + 
               alt_mean + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean, data=trial)
# drop function
m2.fun <- lm(log10.sporeAspectRatio ~ order + SporeType + 
               alt_mean + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean, data=trial)
# drop spore type
m2.typ <- lm(log10.sporeAspectRatio ~ order + simpleFunct + 
               alt_mean + mat_mean + map_mean + seasonality_t_mean + seasonality_p_mean + maxsrad_mean + minvapr_mean, data=trial)
# drop environment
m2.env <- lm(log10.sporeAspectRatio ~ order + simpleFunct + SporeType, data=trial)
# make table
m2.drp <- data.frame(term=c('<none>', 'taxonomy', 'simpleFunct', 'SporeType', 'climate'), 
                     df=AIC(m1, m2.tax, m2.fun, m2.typ, m2.env)[['df']], 
                     AIC=AIC(m1, m2.tax, m2.fun, m2.typ, m2.env)[['AIC']], 
                     AdjR2=sapply(list(m1, m2.tax, m2.fun, m2.typ, m2.env), function(x)summary(x)[['adj.r.squared']]), 
                     row.names=NULL) %>% 
  mutate(type = c('global', rep('subset', n() - 1)), 
         dAIC = AIC - AIC[1], 
         dAdjR2 = AdjR2 - AdjR2[1]) %>% 
  group_by(type) %>% 
  arrange(desc(dAIC), .by_group=TRUE) %>% 
  ungroup() %>% 
  select(term, df, AIC, dAIC, AdjR2, dAdjR2)

# Table 1
dust(m1.drp, caption='Table X. Importance of individual variables in linear models for explaining variation among species in spore shape. Degrees of freedom (df), Akaike\'s Information Criterion (AIC), delta AIC (dAIC), adjusted R^2 (Adj. R2) and delta adjusted R^2 (dAdj. R2) were calculated by dropping terms from a global model containing all terms (indicated in italics).') %>%
  sprinkle_print_method('markdown')  %>%
  sprinkle(rows=1, italic=TRUE) %>%
  sprinkle(cols=c(3, 4), round=1) %>%
  sprinkle(cols=c(5, 6), round=3)

# Table 2
dust(m2.drp, caption='Table X. Importance of variable groupss in linear models for explaining variation among species in spore shape. Degrees of freedom (df), Akaike\'s Information Criterion (AIC), delta AIC (dAIC), adjusted R^2 (Adj. R2) and delta adjusted R^2 (dAdj. R2) were calculated by dropping groups of terms from a global model containing all terms (indicated in italics). ') %>%
  sprinkle_print_method('markdown')  %>%
  sprinkle(rows=1, italic=TRUE) %>%
  sprinkle(cols=c(3, 4), round=1) %>%
  sprinkle(cols=c(5, 6), round=3)

```


# Figures

## Figure 1 (further modified in inkspace)

### Figure 1 Phylogenetic Tree

Genome tree (Li tree)
```{r}
# This is the version done with the genome tree tree (modified by Carlos)

library(ape)

# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("ggtree")

library(ggtree)

#devtools::install_github("ropenscilabs/datastorr")
#devtools::install_github("wcornwell/taxonlookup")

library(taxonlookup)

# The Li tree contains 1644 fungi plus 28 sps of outgroup (i.e. not fungi)
tt <- Li_tree

# This tree contains does not contain the outgroups (28 sps), that is, it only contains
# fungi
Li_tree2<-read.tree("1644taxa_290genes_bb_1_root.tre")
outgroups <- which(!Li_tree$tip.label%in%Li_tree2$tip.label)

#Li_tree$tip.label[outgroups] # Below the names just in case

# Root in the tree
tt <- root(tt, outgroup = outgroups, resolve.root = T)#; rm(Li_tree2)
# pdf("checking_tree")
# plot(tt, cex = 0.5)
# dev.off()
#
#tt <- root(tt, outgroup = "Ichthyophonus_hoferi")#; rm(Li_tree2)

#read in genus in order lookup
only_one_genera_per_order <- Li_tree_names[-which(duplicated(Li_tree_names$order)),
                        c("orginal_tree_names", "order")]

names(only_one_genera_per_order)[1] <- "genus"

#removing the "incertae sedis" order

only_one_genera_per_order <- only_one_genera_per_order[-grep("sedis",                                                          only_one_genera_per_order$order), ]

dropped.tree2 <- drop.tip(tt,tt$tip.label[which(!tt$tip.label %in% only_one_genera_per_order$genus)])

# Replace the names of the genus with the name of the orders
dropped.tree2$tip.label <- only_one_genera_per_order$order[match(dropped.tree2$tip.label,
                                        only_one_genera_per_order$genus)]
```

These are the 28 outgroups in the Li tree: 

[1] "Ichthyophonus_hoferi"             "Creolimax_fragrantissima"        
 [3] "Sphaeroforma_sirkka"              "Sphaeroforma_arctica"            
 [5] "Ichthyosporea_sp._XGB_2017a"      "Strigamia_maritima"              
 [7] "Ixodes_scapularis"                "Daphnia_pulex"                   
 [9] "Drosophila_melanogaster"          "Octopus_bimaculoides"            
[11] "Lottia_gigantea"                  "Lingula_anatina"                 
[13] "Capitella_teleta"                 "Helobdella_robusta"              
[15] "Branchiostoma_lanceolatum"        "Mus_musculus"                    
[17] "Ciona_intestinalis"               "Strongylocentrotus_purpuratus"   
[19] "Trichoplax_adhaerens"             "Nematostella_vectensis"          
[21] "Amphimedon_queenslandica"         "Mnemiopsis_leidyi"               
[23] "Salpingoeca_rosetta"              "Monosiga_brevicollis_MX1"        
[25] "Capsaspora_owczarzaki_ATCC_30864" "Corallochytrium_limacisporum"    
[27] "Fonticula_alba"                   "Fonticula_like_sp_SCN_57_25"     



```{r}
#read in spore data and calculate size and shape variables
matched_data <- filter(Spore_functions,order%in%dropped.tree2$tip.label)
matched_data <- ungroup(matched_data)
matched_data$log.length <- log10(matched_data$spore_length)
matched_data$log_spore_volume <- log10((matched_data$spore_width^2)*matched_data$spore_length*(pi/6))
matched_data$length_divided_by_width <- log10(matched_data$spore_length/matched_data$spore_width)


#check tree
#dropped.tree2$tip.label %in% matched_data$order

#relabel to ggtree convention
matched_data$id <- matched_data$order

#drop not assigned taxa; there are multiple spots on tree with non assigned taxa
matched_data <- filter(matched_data,order!="Not assigned")
dropped.tree2 <- drop.tip(dropped.tree2,"Not assigned")

#select only necessary data
#temp<-select(match2,id,log_spore_area,SporeName,length_divided_by_width)
temp <- select(matched_data,
             id, phylum,log_spore_volume, SporeType, length_divided_by_width)

# summarize data # My modification
sumbox<-temp %>%
  group_by(id, phylum,SporeType) %>%
  summarise(
    n=n(),
    meanV=mean(log_spore_volume),
    meanQ=mean(length_divided_by_width),
    sdV=sd(log_spore_volume),
    sdQ=sd(length_divided_by_width)
  ) %>%
  mutate(seV=sdV/sqrt(n)) %>%
  mutate(seQ=sdQ/sqrt(n))

#sumbox[sumbox$n==1,][,c("meanV","meanQ","sdV","sdQ","seV","seQ")]<-NA
#Orders for which we only have 1 species
just_one<-
  temp %>% 
  group_by(id) %>% 
  count() %>% 
  filter(n==1)
#These are the Basidiobolales and the Dimargitales

dropped.tree2<-drop.tip(dropped.tree2,dropped.tree2$tip.label[match(just_one$id, 
                                                                    dropped.tree2$tip.label)])

sumbox<-sumbox[-which(sumbox$n==1),]

plot.phylo(dropped.tree2, use.edge.length = F, cex = 0.3, no.margin = T)

# Saved version without lables (labels are given in the panel with the symbioses symbols
# they match!)
pdf("Figures/Figure_1/Figure1_phylo_tree.pdf",
   width = 4.43,
    height = 14.5)
plot.phylo(dropped.tree2, use.edge.length = F, cex = 0.3, no.margin = T,
           show.tip.label = FALSE)

dev.off()

```

Metchnikovellida
Meiodihaplophasida
Dissociodihaplophasida
Glugeida
Blastocladiales
Neocallimastigales
Spizellomycetales
Chytridiales
Rhizophydiales
Zoopagales
Entomophthorales
Dimargaritales
Kickxellales
Harpellales
Basidiobolales
Mortierellales
Diversisporales
Glomerales
Endogonales
Umbelopsidales
Mucorales
Pucciniales
Microbotryales
Georgefischeriales
Tilletiales
Ustilaginales
Microstromatales
Exobasidiales
Ceraceosorales
Wallemiales
Tremellales
Trichosporonales
Dacrymycetales
Cantharellales
Auriculariales
Geastrales
Gomphales
Trechisporales
Hymenochaetales
Jaapiales
Gloeophyllales
Russulales
Thelephorales
Polyporales
Boletales
Atheliales
Agaricales
Corticiales
Taphrinales
Saccharomycetales
Orbiliales
Pezizales
Helotiales
Erysiphales
Amphisphaeriales
Xylariales
Microascales
Chaetosphaeriales
Hypocreales
Glomerellales
Coniochaetales
Sordariales
Togniniales
Diaporthales
Ophiostomatales
Magnaporthales
Arthoniales
Dothideales
Myriangiales
Mycosphaerellales
Capnodiales
Venturiales
Botryosphaeriales
Hysteriales
Patellariales
Pleosporales
Mytilinidiales
Umbilicariales
Lecanorales
Phaeomoniellales
Verrucariales
Chaetothyriales
Ascosphaerales
Onygenales
Eurotiales


Figure 1. Panel C: shapes for each level of symbiosis
```{r}
en_orden <-
c("Metchnikovellida", "Meiodihaplophasida", "Dissociodihaplophasida", "Glugeida",
"Blastocladiales", "Neocallimastigales", "Spizellomycetales", "Chytridiales",
"Rhizophydiales", "Zoopagales", "Entomophthorales", "Dimargaritales","Kickxellales",
"Harpellales", "Basidiobolales", "Mortierellales", "Diversisporales", "Glomerales",
"Endogonales", "Umbelopsidales", "Mucorales", "Pucciniales", "Microbotryales",
"Georgefischeriales", "Tilletiales", "Ustilaginales", "Microstromatales",
"Exobasidiales", "Ceraceosorales", "Wallemiales", "Tremellales", "Trichosporonales",
"Dacrymycetales", "Cantharellales", "Auriculariales", "Geastrales", "Gomphales",
"Trechisporales", "Hymenochaetales", "Jaapiales",
"Gloeophyllales", "Russulales", "Thelephorales", "Polyporales", "Boletales",
"Atheliales", "Agaricales", "Corticiales", "Taphrinales", "Saccharomycetales",
"Orbiliales", "Pezizales", "Helotiales", "Erysiphales", "Amphisphaeriales",
"Xylariales", "Microascales", "Chaetosphaeriales", "Hypocreales", "Glomerellales",
"Coniochaetales", "Sordariales", "Togniniales", "Diaporthales",
"Ophiostomatales", "Magnaporthales", "Arthoniales", "Dothideales", "Myriangiales",
"Mycosphaerellales", "Capnodiales", "Venturiales", "Botryosphaeriales",
"Hysteriales", "Patellariales", "Pleosporales", "Mytilinidiales", "Umbilicariales",
"Lecanorales", "Phaeomoniellales", "Verrucariales", "Chaetothyriales",
"Ascosphaerales", "Onygenales", "Eurotiales")

en_orden <- en_orden[85:1]


nombres <-   
left_join(data.frame(order = en_orden),
Spore_functions %>% 
  filter(order%in%dropped.tree2$tip.label) %>%
  group_by(order) %>% 
  count())

#nombres <- paste(nombres$order, paste("(", "n=", nombres$n, ")", sep = ""), sep = " ")

#parte <- paste("(", "n=", nombres$n, ")", sep = "")
ID <- paste(nombres$order,
                  paste("(", "n=", nombres$n, ")", sep = ""),
                  sep = " ")



pdf("Figures/Figure_1/Figure1_symbioses_symbols.pdf",
   width = 3.64,
    height = 14.75)

Spore_functions %>% 
  filter(order%in%dropped.tree2$tip.label) %>%
  mutate(Life_style = recode(Life_style, Plant = "Facultative_association")) %>% 
  mutate(Life_style = gsub(" ", "_", Life_style)) %>% 
  filter(Life_style=="AFree_living"|
           Life_style=="Facultative_association"|
           Life_style=="B_Opportunistic_association"|
           Life_style=="Obligate_association") %>%
  mutate(Life_style = recode(Life_style, B_Opportunistic_association = "Asymbiotic")) %>% 
  mutate(Life_style = recode(Life_style, AFree_living = "Asymbiotic")) %>%
  mutate(Life_style = recode(Life_style, Facultative_association = "Facultative\nsymbiosis")) %>% 
  mutate(Life_style = recode(Life_style, Obligate_association = "Obligate\nsymbiosis")) %>%
  group_by(phylum, order, Life_style) %>% 
  summarise(n = n()) %>% 
  #filter(n > 1) %>%
  mutate(order = factor(order, levels = en_orden)) %>% 
  ggplot()+
  aes(x=Life_style,y= order,shape=Life_style) +
  geom_point(size = 4) +
  scale_shape_manual(values = c(15, 17, 16)) +
  scale_x_discrete(position = "top", 
                   breaks = c("Asymbiotic", "Facultative\nsymbiosis", "Obligate\nsymbiosis"),
                   labels = c("Asymbiotic", "Facultative", "Obligate")) +
  scale_y_discrete(breaks = en_orden,
                   labels = ID) +
  theme(panel.background = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(size= 15, angle = 45, hjust = 0, face = "bold", colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(hjust = 0, face = "italic", colour = "black"),
        legend.text = element_text(size = 10),
        legend.position = "none")

dev.off()

```



Figure 1: Comparing spore size with that of seeds and eggs

```{r}
rbind(
  AllFungi%>%
        group_by(phylum,names_to_use,SporeName,Specific_sporeName)%>%
      summarise_at(c("spore_length","spore_width","SporeArea","SporeVolume","Q_ratio"),mean) %>% 
                          select(names_to_use,SporeVolume)%>%
                          rename(offsrpingSize=SporeVolume)%>%
                          #filter(good.names!="Glomus_tenue")%>%
                          mutate(Taxa="Fungi")%>%
                          mutate(offsrpingSize=offsrpingSize/((10000)^3)),#%>%
                          #mutate(Organism="Microorganism"),
                        
                        kewData%>%
                          select(species,value)%>%
                          rename(names_to_use=species, offsrpingSize=value)%>%
                          mutate(Taxa="Plants"),#%>%
                          #mutate(Organism="Macroorganism"),
                        BirdEgg%>%
                          select(Species,Volume)%>%
                          rename(names_to_use=Species,offsrpingSize=Volume)%>%
                          mutate(Taxa="Birds"))%>%
                      #mutate(Taxa=factor(Taxa,levels =c("Birds","Plants","Fungi"))) %>% 
                      mutate(Taxa=factor(Taxa,levels = c("Fungi","Plants","Birds"))) %>% #For the coord flip version is better in this reverse order
                          #mutate(Organism="Macroorganism"))%>%
                    
                    ggplot()+
                    aes(Taxa,offsrpingSize)+
                    geom_jitter(alpha=0.9,size=4,width = 0.3,color="#FD8D3C")+
  #fe8d3ce6
                    geom_violin(alpha=0.5,
                          lwd=1,
                          fill=NA)+
                    #facet_grid(. ~ Organism, scales = "free")+
                    scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
                    labs(x="Offspring structure",y=expression("Offspring size as volume ("*c*"m)"))+
                    #scale_color_brewer(palette="Accent")+
                    scale_x_discrete(labels=c("Birds" = "Birds\n(eggs)", "Plants"="Plants\n(seeds)","Fungi"="Fungi\n(spores)"))+
  
                      theme(title = element_text(size = 18),
                      panel.background = element_blank(),
                      panel.grid.major = element_line(size = 0.5, linetype = 'longdash',
                                                      colour = "gray"),
                      # panel.grid.minor = element_line(size = 0.5, linetype = 'longdash',
                      #                                 colour = "gray"),
                      axis.title.x=element_blank(),
                      axis.text.x = element_text(size = 20),#,angle = 45,hjust = 1),
                      axis.text.y = element_blank(),
                      #axis.title.x = element_text(size = 20),
                      axis.title.y = element_blank(),
                      legend.position = "none")+
  coord_flip()

```

Figure 1 Heatmaps

```{r}
datos <- 
Spore_functions %>% 
  filter(order%in%dropped.tree2$tip.label) %>%
  filter(names_to_use != "Minimedusa polyspora") %>% 
  # mutate(Life_style = recode(Life_style, Plant = "Facultative_association")) %>% 
  # mutate(Life_style = gsub(" ", "_", Life_style)) %>% 
  # filter(Life_style=="AFree_living"|
  #          Life_style=="Facultative_association"|
  #          Life_style=="B_Opportunistic_association"|
  #          Life_style=="Obligate_association") %>%
  # mutate(Life_style = recode(Life_style, B_Opportunistic_association = "Asymbiotic")) %>% 
  # mutate(Life_style = recode(Life_style, AFree_living = "Asymbiotic")) %>%
  # mutate(Life_style = recode(Life_style, Facultative_association = "Facultative\nsymbiosis")) %>% 
  # mutate(Life_style = recode(Life_style, Obligate_association = "Obligate\nsymbiosis")) %>%
  group_by(order, SporeType) %>% 
  summarise(meanV = mean(log10(SporeVolume)),
            Vol_CV = sd(log10(SporeVolume))/mean(log10(SporeVolume))) %>% 
  ungroup() %>% 
  select(order, SporeType, meanV,Vol_CV) %>% 
  pivot_wider(names_from = SporeType,values_from = c(meanV,Vol_CV))# %>% 
  # mutate(order = factor(order, levels = en_orden)) %>% 
  # ggplot() +
  # geom_tile(aes(x=SporeType, y= order, fill=meanV)) +


datos1 <-as.matrix(datos[,c( "meanV_Meiospores",#"sdV_Meiospores",
                            "meanV_Mitospores",#"sdV_Mitospores",
                            "meanV_Multinucleate sexual spores",
                            "meanV_Multinucleate asexual spores")])#"sdV_Multinucleate asexual spores",
                            #,"sdV_Multinucleate sexual spores"#,
                                                        #)])
rownames(datos1) <- datos$order
datos1 <- datos1[match(en_orden,rownames(datos1)), ]

datos2 <- as.matrix(datos[,c( "Vol_CV_Meiospores",
                            "Vol_CV_Mitospores",
                            "Vol_CV_Multinucleate sexual spores",
                            "Vol_CV_Multinucleate asexual spores")])
rownames(datos2) <- datos$order
datos2 <- datos2[match(en_orden,rownames(datos2)), ]

```



```{r}
library(RColorBrewer)
coul<-colorRampPalette(brewer.pal(9, "Blues"))(100)
#Volume

#Saving using pdf() does not work well, so better click based with the name:
#"Figures/Figure_1/Figure1_heatmaps_vol_mean.pdf", and dimensions:
#   width = 16,
#    height = 19)
heatmap(datos1,Colv = NA, Rowv = NA,cexCol = 0.5,cexRow = 0.5, scale = "none", labRow = F, labCol = F,
        col=hcl.colors(12, "YlOrRd", rev = TRUE))
legend(x="bottomright", legend=c("a", "b", "c","d","e"), 
       fill=hcl.colors(5, "YlOrRd", rev = TRUE)[5:1])

```



## Figure 2 and Table S8 (colors were modified manually in inkscape)


Table S8. Number of unique species (accepted species names) for which we obtained per phylum, spore type and functional group.

```{r}
contando_grupos<-
To_Analysis_c%>% 
  #filter(!Life_style=="Fungi") %>%
  #filter(!simpleFunct == "Animal") %>%
  filter(!simpleFunct == "Ants") %>%
  filter(!simpleFunct == "Nematode") %>%
  filter(!simpleFunct == "Protist") %>%
  filter(!simpleFunct == "Termite") %>%
  filter(!simpleFunct == "Unknown") %>%
  filter(!simpleFunct == "Algae") %>%
  filter(!simpleFunct == "Rotifer") %>%
  filter(!simpleFunct == "Plant mycorrhizal") %>% 
  mutate(simpleFunct = recode(simpleFunct, Animal = "Animal Parasite")) %>% 
  mutate(simpleFunct = recode(simpleFunct, Fungi = "Fungal Parasite")) %>% 
  mutate(simpleFunct = recode(simpleFunct, Human = "Human Pathogen")) %>% 
  #mutate(simpleFunct = recode(simpleFunct, A_Saprotroph = "Asymbiotic\n(Saprotroph)")) %>% 
  filter(!grepl("Chytrid|Ergot|Mammal", simpleFunct, ignore.case = T)) %>% 
  filter(!grepl("Multi", SporeType)) %>% 
  filter(!(simpleFunct == "Plant Ectomycorrhizal"&SporeType == "Mitospores")) %>%
  filter(!(simpleFunct == "Animal Parasite"&SporeType == "Meiospores")) %>% 
  group_by(phylum, order, SporeType, simpleFunct) %>% 
  summarise(n= n())

write.table(contando_grupos,"model_outputs/contando_grupos.txt",
            row.names = F,
            sep = ";")
```


Figure 2. Spore size along different lifestyles

Current
```{r}
# Bubble plot option

my_theme <- theme(#title = element_text(size = 18),
                       #plot.background = element_rect(fill="gray95"),
                       panel.background = element_rect(fill = "gray95"),
                       #panel.background = element_blank(),
                       panel.border = element_rect(fill = NA, size = 2),
                       
                       panel.grid.major.x = element_blank(),
                       panel.grid.major.y = element_line(size = 1, linetype = 'longdash',
                                                         colour = "white"),
                       axis.title.y = element_text(size = 20),
                       axis.title.x = element_blank(),
                       axis.text.x = element_text(size = 20),#, angle = 45, hjust = 1),
                       axis.text.y = element_text(size=20),
                       strip.background = element_blank(),
                       strip.text = element_text(size = 20, face = "bold"),
                       legend.title = element_text(size=15, face = "bold", colour = "black"),
                       legend.title.align = 0.5,
                       legend.position = "bottom",
                       legend.key = element_blank()
                       # strip.text.x = element_blank(),
                       # strip.text.y = element_blank()
                       #axis.line.x = element_line(size=3),
                       #legend.title=element_blank(),
                       #panel.spacing = unit(-7, 'inches'))
                       )



To_Analysis_c <- To_Analysis

# Zygomycetous fungi
To_Analysis_c$phylum[To_Analysis_c$phylum=="\"Zygomycetous fungi\""] <- "Zygomycetous\nfungi"
To_Analysis_c$phylum[To_Analysis_c$phylum=="Zoopagomycota"] <- "Zygomycetous\nfungi"
To_Analysis_c$phylum[To_Analysis_c$phylum=="Mucoromycota"] <- "Zygomycetous\nfungi"
To_Analysis_c$phylum[To_Analysis_c$phylum=="Zygomycetous fungi"] <- "Zygomycetous\nfungi"

# Zoosporic fungi
To_Analysis_c$phylum[To_Analysis_c$phylum=="Blastocladiomycota"] <- "Zoosporic\nfungi"
To_Analysis_c$phylum[To_Analysis_c$phylum=="Neocallimastigomycota"] <- "Zoosporic\nfungi"
To_Analysis_c$phylum[To_Analysis_c$phylum=="Chytridiomycota"] <- "Zoosporic\nfungi"

To_Analysis_c$Life_style <- gsub(" ", "_", To_Analysis_c$Life_style)

To_Analysis_c$Type <- To_Analysis_c$SporeType
To_Analysis_c$Type <- gsub("Meiospores", "Sexual spores", To_Analysis_c$Type)
To_Analysis_c$Type <- gsub("Multinucleate sexual spores", "Sexual spores", To_Analysis_c$Type)
To_Analysis_c$Type <- gsub("Mitospores", "Asexual spores", To_Analysis_c$Type)
To_Analysis_c$Type <- gsub("Multinucleate asexual spores", "Asexual spores", To_Analysis_c$Type)


pdf("Figures/Figure_2/Figure2_bubbleplot.pdf",
    width = 14,
    height = 8.5)
To_Analysis_c%>% 
  filter(!Life_style=="Fungi") %>%
  filter(!Life_style=="Animal") %>%
  filter(!Life_style=="Ants") %>%
  filter(!Life_style=="Nematode") %>%
  #filter(!grepl("Multi", SporeType)) %>% 
  filter(!grepl("Multinucleate sexual", SporeType)) %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative_association")) %>% 
  mutate(Life_style = recode(Life_style, B_Opportunistic_association = "Asymbiotic")) %>% 
  mutate(Life_style = recode(Life_style, AFree_living = "Asymbiotic")) %>%
  mutate(Life_style = recode(Life_style, Facultative_association = "Facultative\nsymbiosis")) %>% 
  mutate(Life_style = recode(Life_style, Obligate_association = "Obligate\nsymbiosis")) %>%
  #group_by(phylum, order, SporeType, Life_style) %>% 
  group_by(phylum, order, Type, Life_style) %>% 
  summarise(meanV = mean(SporeVolume), cvarV = sd(SporeVolume)/mean(SporeVolume),
            n= n()) %>% 
  
  ggplot()+
  aes(x = Life_style,
      y = meanV)+
  geom_jitter(aes(color = phylum, size= cvarV),
              alpha = 0.8, width = 0.2) +
  guides(size = guide_legend(title="Coefficient of\nvariation"),
         color = guide_legend(title = element_blank(),
                              label.theme = element_text(size = 15),
                              override.aes = list(size = 7))) +
  scale_size(range = c(1, 10)) +
  stat_summary(#aes(color = phylum), 
               fun = "median", size= 0.8, width = 0.5,
               geom = "crossbar") +
  
  scale_y_log10(breaks=c(10^1,10^2,10^3,10^4,10^5),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_color_brewer(palette = "Dark2") +
  #facet_wrap(SporeType~.)+ #, scales = "free_y") +
  facet_wrap(Type~.)+ #, scales = "free_y") +
  labs(y = expression("Spore size ("*mu*"m)")) +
  my_theme
dev.off() 
###

#Supp figure
pdf("Figures/Figure_2/FigureS2_bubbleplot.pdf",
    width = 14,
    height = 8.5)
To_Analysis_c%>% 
  #filter(!Life_style=="Fungi") %>%
  #filter(!simpleFunct == "Animal") %>%
  filter(!simpleFunct == "Ants") %>%
  filter(!simpleFunct == "Nematode") %>%
  filter(!simpleFunct == "Protist") %>%
  filter(!simpleFunct == "Termite") %>%
  filter(!simpleFunct == "Unknown") %>%
  filter(!simpleFunct == "Algae") %>%
  filter(!simpleFunct == "Rotifer") %>%
  filter(!simpleFunct == "Plant mycorrhizal") %>% 
  mutate(simpleFunct = recode(simpleFunct, Animal = "Animal Parasite")) %>% 
  mutate(simpleFunct = recode(simpleFunct, Fungi = "Fungal Parasite")) %>% 
  mutate(simpleFunct = recode(simpleFunct, Human = "Human Pathogen")) %>% 
  #mutate(simpleFunct = recode(simpleFunct, A_Saprotroph = "Asymbiotic\n(Saprotroph)")) %>% 
  filter(!grepl("Chytrid|Ergot|Mammal", simpleFunct, ignore.case = T)) %>% 
  filter(!grepl("Multi", SporeType)) %>% 
  filter(!(simpleFunct == "Plant Ectomycorrhizal"&SporeType == "Mitospores")) %>%
  filter(!(simpleFunct == "Animal Parasite"&SporeType == "Meiospores")) %>% 
  group_by(phylum, order, SporeType, simpleFunct) %>% 
  summarise(meanV = mean(SporeVolume), cvarV = sd(SporeVolume)/mean(SporeVolume),
            n= n()) %>% 
  
  ggplot()+
  aes(x = simpleFunct,
      y = meanV)+
  geom_jitter(aes(color = phylum, size= cvarV),
              alpha = 0.8, width = 0.2) +
  guides(size = guide_legend(title="Coefficient of\nvariation", override.aes = list(size = 7)),
         color = guide_legend(title = element_blank(), 
                              label.theme = element_text(size = 15),
                              override.aes = list(size = 7))) +
  scale_size(range = c(1, 10)) +
  stat_summary(#aes(color = phylum), 
    fun = "median", size= 0.8, width = 0.5,
    geom = "crossbar") +
  
  scale_y_log10(breaks=c(10^1,10^2,10^3,10^4,10^5),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(SporeType~., scales = "free_x")+ #, scales = "free_y") +
  labs(y = expression("Spore size ("*mu*"m)")) +
  theme(panel.background = element_rect(fill = "gray95"),
    panel.border = element_rect(fill = NA, size = 2),
    
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 1, linetype = 'longdash',
                                      colour = "white"),
    axis.title.y = element_text(size = 20),
    axis.title.x = element_blank(),
    axis.text.x = element_text(size = 14, angle = 45, hjust = 1),
    axis.text.y = element_text(size=20),
    strip.background = element_blank(),
    strip.text = element_text(size = 20, face = "bold"),
    legend.title = element_text(size=15, face = "bold", colour = "black"),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.key = element_blank())
dev.off()

```


##Figure 3

## Spore volume

I need to ask Jeff for the code he used to create "brmsoutput_sporeVolume.RData"

```{r, eval=FALSE}

library(brms)
library(ggridges)
library(patchwork)
temp<-left_join(read_csv('output/df_species_byPrimerSet.csv') %>%
                   mutate(names_to_use = gsub("_", " ", Species)) %>%
                   select(names_to_use, host.assoc, Primers.name, log10.sporeVolume, log10.sporeAspectRatio, starts_with('geo_'), ends_with('_sd'), n_samples_env),
                 To_Analysis[,c("names_to_use","SporeType","simpleFunct","Life_style",
                                "phylum","class","order")]) %>% 
  filter(!order == 'Not assigned') %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative association", 
                             `B_Opportunistic association` = "AFree living")) %>% 
  mutate(simpleFunct = recode(simpleFunct, Human = "A_Saprotroph")) %>% 
  filter(grepl("Sapro|Plant", simpleFunct))


load('output/brmsoutput_sporeVolume.RData')

### confidence bands for slope

# ext
slp.a <- c(attr(fit1.ext$fit, 'sim')$samples[[1]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[2]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[3]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[4]][['b_log10.sporeVolume']][1001:2000])
conf.95.a <- slp.a > quantile(slp.a, prob=0.025) & slp.a < quantile(slp.a, prob=0.975)
conf.50.a <- slp.a > quantile(slp.a, prob=0.25) & slp.a < quantile(slp.a, prob=0.75)
# slp.b <- c(attr(fit1.ext$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.ext$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.ext$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.ext$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000])
# conf.95.b <- slp.b > quantile(slp.b, prob=0.025) & slp.b < quantile(slp.b, prob=0.975)
# conf.50.b <- slp.b > quantile(slp.b, prob=0.25) & slp.b < quantile(slp.b, prob=0.75)
slp.c <- c(attr(fit1.ext$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000])
conf.95.c <- slp.c > quantile(slp.c, prob=0.025) & slp.c < quantile(slp.c, prob=0.975)
conf.50.c <- slp.c > quantile(slp.c, prob=0.25) & slp.c < quantile(slp.c, prob=0.75)
slp.d <- c(attr(fit1.ext$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.ext$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000])
conf.95.d <- slp.d > quantile(slp.d, prob=0.025) & slp.d < quantile(slp.d, prob=0.975)
conf.50.d <- slp.d > quantile(slp.d, prob=0.25) & slp.d < quantile(slp.d, prob=0.75)
slp.ext <- bind_rows(data.frame(Life_style='free-living', response='extent', slope=slp.a, conf.50=conf.50.a, conf.95=conf.95.a), 
                   # data.frame(Life_style='opportunistic', response='extent', slope=slp.a+slp.b, conf.50=conf.50.b, conf.95=conf.95.b), 
                   data.frame(Life_style='facultative', response='extent', slope=slp.a+slp.c, conf.50=conf.50.c, conf.95=conf.95.c), 
                   data.frame(Life_style='obligate', response='extent', slope=slp.a+slp.d, conf.50=conf.50.d, conf.95=conf.95.d))
rm(slp.a, slp.b, slp.c, slp.d, conf.95.a, conf.50.a, conf.95.b, conf.50.b, conf.95.c, conf.50.c, conf.95.d, conf.50.d)

# area
slp.a <- c(attr(fit1.area$fit, 'sim')$samples[[1]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[2]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[3]][['b_log10.sporeVolume']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[4]][['b_log10.sporeVolume']][1001:2000])
conf.95.a <- slp.a > quantile(slp.a, prob=0.025) & slp.a < quantile(slp.a, prob=0.975)
conf.50.a <- slp.a > quantile(slp.a, prob=0.25) & slp.a < quantile(slp.a, prob=0.75)
# slp.b <- c(attr(fit1.area$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.area$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.area$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000], 
#            attr(fit1.area$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleB_Opportunisticassociation']][1001:2000])
# conf.95.b <- slp.b > quantile(slp.b, prob=0.025) & slp.b < quantile(slp.b, prob=0.975)
# conf.50.b <- slp.b > quantile(slp.b, prob=0.25) & slp.b < quantile(slp.b, prob=0.75)
slp.c <- c(attr(fit1.area$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleFacultativeassociation']][1001:2000])
conf.95.c <- slp.c > quantile(slp.c, prob=0.025) & slp.c < quantile(slp.c, prob=0.975)
conf.50.c <- slp.c > quantile(slp.c, prob=0.25) & slp.c < quantile(slp.c, prob=0.75)
slp.d <- c(attr(fit1.area$fit, 'sim')$samples[[1]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[2]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[3]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000], 
           attr(fit1.area$fit, 'sim')$samples[[4]][['b_log10.sporeVolume:Life_styleObligateassociation']][1001:2000])
conf.95.d <- slp.d > quantile(slp.d, prob=0.025) & slp.d < quantile(slp.d, prob=0.975)
conf.50.d <- slp.d > quantile(slp.d, prob=0.25) & slp.d < quantile(slp.d, prob=0.75)
slp.area <- bind_rows(data.frame(Life_style='free-living', response='area', slope=slp.a, conf.50=conf.50.a, conf.95=conf.95.a), 
                   # data.frame(Life_style='opportunistic', response='area', slope=slp.a+slp.b, conf.50=conf.50.b, conf.95=conf.95.b), 
                   data.frame(Life_style='facultative', response='area', slope=slp.a+slp.c, conf.50=conf.50.c, conf.95=conf.95.c), 
                   data.frame(Life_style='obligate', response='area', slope=slp.a+slp.d, conf.50=conf.50.d, conf.95=conf.95.d))
rm(slp.a, slp.b, slp.c, slp.d, conf.95.a, conf.50.a, conf.95.b, conf.50.b, conf.95.c, conf.50.c, conf.95.d, conf.50.d)

# join
slp <- bind_rows(slp.ext, slp.area) %>% 
  mutate(Life_style = factor(Life_style, levels=c('free-living', 'opportunistic', 'facultative', 'obligate')))
slp %>% group_by(response, Life_style) %>% summarise(mean=mean(slope))


### plot
labs <- c(area = 'Range area', extent = 'Maximum distance')

# extent and area by volume
temp %>% 
  mutate(Life_style = recode(Life_style, `AFree living`='free-living', `B_Opportunistic association`='opportunistic', 
                             `Facultative association`='facultative', `Obligate association`='obligate'), 
         Life_style = factor(Life_style, levels=c('free-living', 'opportunistic', 'facultative', 'obligate'))) %>% 
  select(order, log10.sporeVolume, Life_style, geo_extent_prop, geo_area_prop) %>% 
  pivot_longer(cols=ends_with('prop'), names_to='response', values_to='value') %>% 
  ggplot(aes(x=log10.sporeVolume, y=car::logit(value), colour=Life_style)) + 
  geom_point(alpha=0.5, shape=16,size=4) + 
  stat_smooth(method='lm', alpha=0.25) + 
  labs(x=expression("Spore size ("*mu*"m)"), y='Geographic extent (relative to maximum distance/area, logit)') + 
  facet_grid(rows=vars(response), scales='free_y') + 
  # scale_colour_manual(name='', values=colorRampPalette(c('black', 'orange'))(3)) +
  scale_color_manual(values= c("#FFFFB2","#FD8D3C", "#E31A1C"))+
  #scale_colour_brewer(palette = "YlOrRd") +
  theme(legend.position='none', 
        panel.background = element_blank(),
        axis.title = element_text(size=25),
        axis.text = element_text(size = 25),
         panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.25, linetype = 'longdash',
                                        colour = "gray"),
        strip.background = element_blank(),
        strip.text.y = element_blank()) -> p1

ggplot(slp, aes(x=slope,  fill=Life_style)) + 
  geom_density(alpha=0.9) + 
  geom_vline(xintercept=0) + 
  labs(x='Slope estimate', y='Density') + 
  facet_grid(rows=vars(response), labeller=labeller(response=labs)) + 
  # scale_colour_manual(name='', values=colorRampPalette(c('black', 'orange'))(3)) + 
  scale_fill_manual(values= c("#FFFFB2","#FD8D3C", "#E31A1C"))+
  #scale_colour_brewer(palette = "YlOrRd") + 
  scale_fill_brewer(palette = "YlOrRd")+
  theme(panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size=25),
        axis.text = element_text(size = 25),
        axis.title = element_text(size=25),
     panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.25, linetype = 'longdash',
                                        colour = "gray")
  )-> p2

p1 + p2



```


According to the CoL (visited on March 2022) there are 1271 Zoosporic fungi; 1085 zygomycetous fungi, Microsporida 1222



## Figure S1
```{r}
#data.frame(table(Spore_functions[, c("phylum")]))
  
Ascos<-c(`Spore` = 20112,`No_spore` = 63713)#83825
Basidios<-c(`Spore` = 8008,`No_spore` = 40397)#48405
Zoos<-c(`Spore` = 21,`No_spore` = 1250)#1271
Glomeros<-c(`Spore` = 274,`No_spore` = 10)#284
Zygos<-c(`Spore` = 511,`No_spore` = 574)#1085
Micro<-c(`Spore` = 15,`No_spore` = 1207)#1222

library(waffle)
library(RColorBrewer)

waffle(
  Ascos / 100, rows = 20, size = 0.5,
  colors = c("blue","light blue"),
  title = "Ascomycota",
  #xlab = "1 square = 100 Species",
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->A

waffle(
  Basidios / 100, rows = 12, size = 0.5,
  colors = c("blue","light blue"),
  title = "Basidiomycota",
  #xlab = "1 square = 100 Species",
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->B

waffle(
  Zoos , rows = 20, size = 0.5,
  colors = c("blue","light blue"),
  title = "Zoosporic fungi",
  #xlab = "1 square = 1 Species", 
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->Zoo

waffle(
  Glomeros , rows = 7, size = 0.5,
  colors = c("blue","light blue"),
  title = "Glomeromycetous fungi",
  #xlab = "1 square = 1 Species",
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->G

waffle(
  Zygos , rows = 20, size = 0.5,
  colors = c("blue","light blue"),
  title = "Zygomycetous fungi",
  #xlab = "1 square = 1 Species", 
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->Z

waffle(
  Micro , rows = 20, size = 0.5,
  colors = c("blue","light blue"),
  title = "Microsporidian fungi",
  #xlab = "1 square = 1 Species", 
  pad = 3,
  legend_pos = "none"
  #use_glyph = "star"
)->M

#Ploting them. First the "higher fungi (A and B) and then the lower fungi (C,G,Z)
#"Figures/Figure_1/Figure1_violinplots.pdf",

pdf("Figures/Figure_S1/Ascos_Basidios.pdf",width = 8.5, height = 11 )
iron(A, B)
dev.off()

pdf("Figures/Figure_S1/glomero_zygos.pdf",width = 8.5, height = 11 )
iron(Z, G)
dev.off()


pdf("Figures/Figure_S1/zoo_micro.pdf",width = 8.5, height = 11 )
iron(Zoo, M)
dev.off()
```


## Figure S2

Upper panel
```{r}

To_Analysis %>% 
  ungroup() %>% 
  filter(phylum=="Ascomycota" | phylum=="Basidiomycota") %>% 
  filter(SporeName=="Ascospores"|SporeName=="Basidiospores") %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative association"), 
         Life_style = recode(Life_style, "B_Opportunistic association" = "AFree living")) %>% 
  ggplot()+
  aes(Life_style,SporeVolume,fill=Life_style)+
  geom_violin(alpha=0.8, draw_quantiles=c(0.25, 0.5, 0.75))+
  facet_grid(.~phylum, scales = "free_y")+
  scale_fill_brewer(palette="YlOrRd")+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(y=expression("Spore size as volume ("*mu*"m)"))+
    theme(panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.25,linetype = 'longdash',
                                        colour = "gray"),
    axis.text.x = element_text(angle=45),
    legend.position = "none",
    axis.title.x=element_blank())
  
```

Lower panel
```{r}
To_Analysis %>% 
  ungroup() %>% 
  filter(!grepl("multi",SporeType,ignore.case = T)) %>% 
  filter(!SporeName=="Ascospores"|SporeName=="Basidiospores") %>% 
  mutate(Life_style = recode(Life_style, Plant = "Facultative association"), 
         Life_style = recode(Life_style, "B_Opportunistic association" = "AFree living")) %>% 
  ggplot()+
  aes(Life_style,SporeVolume,fill=Life_style)+
  geom_violin(alpha=0.8, draw_quantiles=c(0.25, 0.5, 0.75))+
  facet_grid(.~phylum, scales = "free_y")+
  scale_fill_brewer(palette="YlOrRd")+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(y=expression("Spore size as volume ("*mu*"m)"))+
    theme(panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.25,linetype = 'longdash',
                                        colour = "gray"),
    axis.text.x = element_text(angle=45),
    legend.position = "none",
    axis.title.x=element_blank())
```


Supplementary figure

```{r}
library(colorspace)


#This should be placed early on
Spore_functions$phylum[Spore_functions$phylum == "\"Zygomycetous fungi\""] <- "Zygomycetous fungi"

pdf("Figures/Figure_1/Figure1_violinplots.pdf",
   width = 4.8,
    height = 8.4)
Spore_functions%>%
          filter(!is.na(SporeType))%>%#Filtering only because there are so few
  mutate(phylum = recode(phylum, Zoopagomycota = "Zygomycetous fungi")) %>% 
  mutate(phylum = recode(phylum, Mucoromycota = "Zygomycetous fungi")) %>% 
  
  mutate(phylum = recode(phylum, Blastocladiomycota = "Zoosporic fungi")) %>% 
  mutate(phylum = recode(phylum, Neocallimastigomycota = "Zoosporic fungi")) %>% 
  mutate(phylum = recode(phylum, Chytridiomycota = "Zoosporic fungi")) %>% 
  
          group_by(phylum, SporeType, names_to_use)%>%
          summarise_at(c("SporeVolume", "Q_ratio"), mean)%>%
          
          ungroup() %>% 
          
          mutate(phylum_type=paste(phylum,SporeType,sep = " ")) %>% 
  filter(phylum_type != "Microsporidia Meiospores") %>% 
  filter(phylum_type != "Zoosporic fungi Meiospores") %>% 
  
          select(phylum_type,names_to_use,SporeVolume,Q_ratio) %>% 
          group_by(names_to_use) %>% 
          gather(key=variable,
               value=value,SporeVolume:Q_ratio)%>%
  mutate(variable = recode(variable, SporeVolume = "A_SporeVolume")) %>% 
  
  
          group_by(phylum_type,variable) %>% 
          mutate(phylum_mean=mean(log10(value))) %>%
          ungroup() %>% 
  
          ggplot()+
          aes(phylum_type,value,fill=phylum_mean)+
          scale_fill_continuous_sequential(palette="YlOrRd")+
          geom_violin(scale = "width",alpha=0.8, draw_quantiles=c(0.25, 0.5, 0.75)) +
          facet_wrap(variable~., scales = "free", strip.position = "top", nrow = 2) +
          scale_y_log10(breaks=c(10^0,10^1,10^2,10^3,10^4,10^5,10^6,10^7),
                        labels = scales::trans_format("log10", scales::math_format(10^.x)))+
          scale_x_discrete(breaks = c("Ascomycota Meiospores", "Ascomycota Mitospores",
                                      "Basidiomycota Meiospores", "Basidiomycota Mitospores",
                                      "Basidiomycota Multinucleate sexual spores",
                                      "Glomeromycota Multinucleate asexual spores",
                                      "Microsporidia Mitospores",
                                      "Zoosporic\nfungi Mitospores",
                                      "Zygomycetous\nfungi Mitospores",
                                      "Zygomycetous\nfungi Multinucleate asexual spores",
                                      "Zygomycetous\nfungi Multinucleate sexual spores"),
                   labels = c("A-me", "A-mi", "B-me", "B-mi", "B-ms", "G-ma",
                                      "M-mi", "Zoo-mi", "Zy-mi", "Zy-ma", "Zy-ms"),
                   limits = c("Microsporidia Mitospores",
                                      "Zoosporic\nfungi Mitospores",
                                      "Zygomycetous\nfungi Mitospores",
                                      "Zygomycetous\nfungi Multinucleate asexual spores",
                                      "Zygomycetous\nfungi Multinucleate sexual spores",
                                      "Glomeromycota Multinucleate asexual spores",
                                    "Ascomycota Meiospores", "Ascomycota Mitospores",
                                      "Basidiomycota Meiospores", "Basidiomycota Mitospores",
                                      "Basidiomycota Multinucleate sexual spores")) +
          #labs(title = expression("Spore Volume ("*mu*"m)"))+
  
        theme(title = element_text(size = 18),
        panel.background = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'longdash',
                                        colour = "gray"),
        
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x = element_text(size= 15, face = "bold", colour = "black",
                                   angle = 45, hjust = 1),
        axis.text.y = element_text(size = 20),
        strip.background = element_blank(),
        strip.text = element_text(size = 20, face = "bold"),
       
        #strip.text = element_text(position = "top"),
        legend.position = "none")

dev.off()
```


Supplementary analysis including/excluding Glomeromycete spores
```{r}
#From temporal4

mo <- which(Li_tree_names$SporeType=="Mitospores")
ma <- which(Li_tree_names$SporeType=="Multinucleate asexual spores")


styles <- c("AFree living", "B_Opportunistic association",
            "Facultative association", "Obligate association") 

#mitospores_wG
mitospores_wG <- Li_tree_names[c(mo, ma), ]
mitospores_wG <- mitospores_wG[-which(mitospores_wG$phylum == "Zygomycetous fungi"&
                                        mitospores_wG$SporeType == "Multinucleate asexual spores"), ]

rownames(mitospores_wG)<-mitospores_wG$orginal_tree_names

mitospores_wG <- mitospores_wG[which(mitospores_wG$Life_style %in% styles), ]
rownames(mitospores_wG) <- mitospores_wG$orginal_tree_names

#mitospores_wG
mitospores_wG2 <- To_Analysis[grep("itospores|asexual", To_Analysis$SporeType), ]

few <- names(which(table(mitospores_wG2$simpleFunct)<3))

mitospores_wG2 <- mitospores_wG2[-which(mitospores_wG2$simpleFunct %in% few), ]
mitospores_wG2 <- mitospores_wG2[-which(mitospores_wG2$simpleFunct == "Unknown"), ]
mitospores_wG2<-mitospores_wG2[-which(duplicated(mitospores_wG2$names_to_use)),]#For some weird reason one species is duplicated, all values are exactly the same so I just removed it

#mitospores_wG2<-mitospores_wG2[-which(mitospores_wG2$Life_style=="Fungi"),]
#mitospores_wG2<-mitospores_wG2[-which(mitospores_wG2$Life_style=="Animal"),]

rownames(mitospores_wG2) <- mitospores_wG2$names_to_use

mitospores_wG2 <- mitospores_wG2[which(mitospores_wG2$Life_style %in% styles), ]
rownames(mitospores_wG2) <- mitospores_wG2$names_to_use

# Contrast

mitospores_wG$Life_style<-as.factor(mitospores_wG$Life_style)
#levels(mitospores_wG$Life_style)
contrasts(mitospores_wG$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)

#################################################################

mitospores_wG2$Life_style<-as.factor(mitospores_wG2$Life_style)
levels(mitospores_wG2$Life_style)
contrasts(mitospores_wG2$Life_style)<-cbind(
  c(-1,-1,1,1),#free living against symbionts
  c(-1,1,0,0),#free living  vs opportunistic symbionts
  c(0,0,-1,1)#Faculative vs Obligate
)

mod_Li_mitos_symb_wG<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = mitospores_wG,
          phy = Li_tree,
          #phy = Li_tree2,
          model = "lambda")

mod_tax_mitos_symb_wG<-
  phylolm(log10(SporeVolume) ~ Life_style,
          data = mitospores_wG2,
          
          phy = tax_tree2,
          #phy = Li_tree2,
          model = "lambda")



####

summary(mod_Li_mitos_symb_wG)

muestra <- mod_Li_mitos_symb_wG$n
modelo <- summary(mod_Li_mitos_symb_wG)

Li_mitos_symb1_wG <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

Li_mitos_symb1_wG <-
  rapply(Li_mitos_symb1_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_mitos_symb2_wG <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_mitos_symb2_wG <-
  rapply(Li_mitos_symb2_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})


##

summary(mod_tax_mitos_symb_wG)
muestra <- mod_tax_mitos_symb_wG$n
modelo <- summary(mod_tax_mitos_symb_wG)

tax_mitos_symb1_wG <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

tax_mitos_symb1_wG <-
  rapply(tax_mitos_symb1_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_mitos_symb2_wG <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_mitos_symb2_wG <-
  rapply(tax_mitos_symb2_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})

###

limpia2 <- function(x){
  names(x)[1] <- "contrast" 
  x$contrast[grep("Life_style1", x$contrast)] <- "Free-living vs Symbiotic"
  x$contrast[grep("Life_style2", x$contrast)] <- "Saprotrophic vs Opportunistic symbionts"
  x$contrast[grep("Life_style3" ,x$contrast)] <- "Facultative symbionts vs Obligate Symbionts"
  x
}

Li_mitos_symb2_wG <- limpia2(Li_mitos_symb2_wG)
tax_mitos_symb2_wG <- limpia2(tax_mitos_symb2_wG)

tablas2 <- 
  rbind(matrix(names(Li_mitos_symb1_wG), nrow = 1, ncol = 4), as.matrix(Li_mitos_symb1_wG), 
        matrix(names(Li_mitos_symb2_wG), nrow = 1, ncol = 4), as.matrix(Li_mitos_symb2_wG),
        
        matrix(names(tax_mitos_symb1_wG), nrow = 1, ncol = 4), as.matrix(tax_mitos_symb1_wG), 
        matrix(names(tax_mitos_symb2_wG), nrow = 1, ncol = 4), as.matrix(tax_mitos_symb2_wG))

tablas2 <- tablas2[-grep("Intercept", tablas2[,1]), ]

rm( Li_mitos_symb1_wG,Li_mitos_symb2_wG, tax_mitos_symb1_wG, tax_mitos_symb2_wG)

write.csv(tablas2,
          "model_outputs/contrast_models_wG.csv",
          row.names = F)

write.table(tablas2,
            "model_outputs/contrast_models_wG.txt", sep =";",
            row.names = F)

##

#Extra
mo <- which(Li_tree_names$SporeType=="Mitospores")
ma <- which(Li_tree_names$SporeType=="Multinucleate asexual spores")


styles <- c("AFree living", "B_Opportunistic association",
            "Facultative association", "Obligate association") 

#mitospores_wG
mitospores_wG <- Li_tree_names[c(mo, ma), ]
mitospores_wG <- mitospores_wG[-which(mitospores_wG$phylum == "Zygomycetous fungi"), ]

#Removing the groups for which we have less than 3 species per function and "unknown" functions
few <- names(which(table(mitospores_wG$simpleFunct)<3))

mitospores_wG <- mitospores_wG[-which(mitospores_wG$simpleFunct %in% few), ]
mitospores_wG <- mitospores_wG[-which(mitospores_wG$simpleFunct == "Unknown"), ]

rownames(mitospores_wG)<-mitospores_wG$orginal_tree_names

mitospores_wG <- mitospores_wG[which(mitospores_wG$Life_style %in% styles), ]
rownames(mitospores_wG) <- mitospores_wG$orginal_tree_names

#mitospores_wG
mitospores_wG2 <- To_Analysis[grep("itospores|asexual", To_Analysis$SporeType), ]

few <- names(which(table(mitospores_wG2$simpleFunct)<3))

mitospores_wG2 <- mitospores_wG2[-which(mitospores_wG2$simpleFunct %in% few), ]
mitospores_wG2 <- mitospores_wG2[-which(mitospores_wG2$simpleFunct == "Unknown"), ]
mitospores_wG2<-mitospores_wG2[-which(duplicated(mitospores_wG2$names_to_use)),]#For some weird reason one species is duplicated, all values are exactly the same so I just removed it
mitospores_wG2 <- mitospores_wG2[-which(mitospores_wG2$phylum == "Zygomycetous fungi"), ]
#mitospores_wG2<-mitospores_wG2[-which(mitospores_wG2$Life_style=="Fungi"),]
#mitospores_wG2<-mitospores_wG2[-which(mitospores_wG2$Life_style=="Animal"),]

rownames(mitospores_wG2) <- mitospores_wG2$names_to_use

mitospores_wG2 <- mitospores_wG2[which(mitospores_wG2$Life_style %in% styles), ]
rownames(mitospores_wG2) <- mitospores_wG2$names_to_use

mod_Li_mitos_wG <- phylolm(log10(SporeVolume) ~ simpleFunct,
                           data = mitospores_wG,
                           phy = Li_tree, 
                           #phy = Li_tree2,
                           model = "lambda")


mod_tax_mitos_wG <- phylolm(log10(SporeVolume) ~ simpleFunct,
                            data = mitospores_wG2,
                            phy = tax_tree2, model = "lambda")

##

summary(mod_Li_mitos_wG)

muestra <- mod_Li_mitos_wG$n
modelo <- summary(mod_Li_mitos_wG)

Li_mitos1_wG <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

Li_mitos1_wG <-
  rapply(Li_mitos1_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})

Li_mitos2_wG <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

Li_mitos2_wG <-
  rapply(Li_mitos2_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})


##

summary(mod_tax_mitos_wG)

muestra <- mod_tax_mitos_wG$n
modelo <- summary(mod_tax_mitos_wG)

tax_mitos1_wG <- 
  data.frame(
    model = paste(modelo$call$data, modelo$call$phy, sep = "_"),
    Pagels_lambda = modelo$optpar,
    r2 = modelo$r.squared,
    n = muestra)

tax_mitos1_wG <-
  rapply(tax_mitos1_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})

tax_mitos2_wG <- 
  broom::tidy(modelo$coefficients)[,c(".rownames", "Estimate", "t.value", "p.value")]

tax_mitos2_wG <-
  rapply(tax_mitos2_wG, classes = "numeric", how = "replace", function(x){round(x, 2)})


###


limpia <- function(x){
  names(x)[1] <- "group" 
  x$group[grep("tercept" ,x$group)] <- "Asymbiotic saptrotrophs"
  x$group[grep("human" ,x$group, ignore.case = T)] <- "Human pathogens"
  x$group[grep("insect" ,x$group, ignore.case = T)] <- "Insect pathogens"
  x$group[grep("Lichen" ,x$group, ignore.case = T)] <- "Lichen fungi"
  x$group[grep("Ecto" ,x$group, ignore.case = T)] <- "Ectomycorrhizal"
  x$group[grep("endoph" ,x$group, ignore.case = T)] <- "Plant endophyte"
  x$group[grep("mildew" ,x$group, ignore.case = T)] <- "Mildew fungi (plant pathogens)"
  x$group[grep("necro" ,x$group, ignore.case = T)] <- "Necrotroph (plant pathogens)"
  x$group[grep("rust" ,x$group, ignore.case = T)] <- "Rust fungi(plant pathogens)"
  x$group[grep("smut" ,x$group, ignore.case = T)] <- "Smut fungi (plant pathogens)"
  x$group[grep("undefined" ,x$group, ignore.case = T)] <- "Undefined plant pathogens"
  x
}

Li_mitos2_wG <- limpia(Li_mitos2_wG)
tax_mitos2_wG <- limpia(tax_mitos2_wG)

tablas <- 
  rbind(matrix(names(Li_mitos1_wG), nrow = 1, ncol = 4), as.matrix(Li_mitos1_wG), 
        matrix(names(Li_mitos2_wG), nrow = 1, ncol = 4), as.matrix(Li_mitos2_wG),
        
        matrix(names(tax_mitos1_wG), nrow = 1, ncol = 4), as.matrix(tax_mitos1_wG), 
        matrix(names(tax_mitos2_wG), nrow = 1, ncol = 4), as.matrix(tax_mitos2_wG))

rm(Li_mitos1_wG, Li_mitos2_wG, tax_mitos1_wG, tax_mitos2_wG)
write.csv(tablas,
          "model_outputs/simple_funct_models_wG.csv",
          row.names = F)

write.table(tablas,
            "model_outputs/simple_funct_models_wG.txt", sep =";",
            row.names = F)


```


